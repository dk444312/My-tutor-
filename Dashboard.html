<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Dashboard - My Tutor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .status-past {
      color: #6b7280;
    }
    .status-upcoming {
      color: #10b981;
    }
    .status-in-progress {
      color: #f59e0b;
      font-weight: bold;
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
  <div class="container max-w-4xl mx-auto p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold"><i class="fas fa-tachometer-alt mr-2"></i>Student Dashboard</h1>
      <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button>
    </div>

    <!-- Sessions Section -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow mb-6">
      <h2 class="text-xl font-semibold mb-4"><i class="fas fa-calendar-check mr-2"></i>Your Sessions</h2>
      <div class="overflow-x-auto">
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-100 dark:bg-gray-700">
              <th class="p-3 text-left"><i class="fas fa-book mr-1"></i>Course</th>
              <th class="p-3 text-left"><i class="fas fa-lightbulb mr-1"></i>Concept</th>
              <th class="p-3 text-left"><i class="fas fa-clock mr-1"></i>Duration</th>
              <th class="p-3 text-left"><i class="fas fa-calendar mr-1"></i>Date</th>
              <th class="p-3 text-left"><i class="fas fa-info-circle mr-1"></i>Status</th>
            </tr>
          </thead>
          <tbody id="sessionList"></tbody>
        </table>
      </div>
    </div>

    <!-- Billing Section -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
      <h2 class="text-xl font-semibold mb-4"><i class="fas fa-dollar-sign mr-2"></i>Your Billing</h2>
      <div class="overflow-x-auto">
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-100 dark:bg-gray-700">
              <th class="p-3 text-left"><i class="fas fa-money-bill mr-1"></i>Amount</th>
              <th class="p-3 text-left"><i class="fas fa-sticky-note mr-1"></i>Note</th>
              <th class="p-3 text-left"><i class="fas fa-calendar mr-1"></i>Date</th>
            </tr>
          </thead>
          <tbody id="billingList"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCthkxyO-M5XSJ93jRO1uMg2J_Bnuq5gvc",
      authDomain: "my-tutor-a87b5.firebaseapp.com",
      projectId: "my-tutor-a87b5",
      storageBucket: "my-tutor-a87b5.appspot.com",
      messagingSenderId: "825619042650",
      appId: "1:825619042650:web:79d85905a01fcb90c12363"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);

    const sessionList = document.getElementById("sessionList");
    const billingList = document.getElementById("billingList");
    const logoutBtn = document.getElementById("logoutBtn");

    // Session Status Logic
    function getSessionStatus(sessionDate, duration) {
      const now = new Date();
      const sessionStart = new Date(sessionDate);
      const sessionEnd = new Date(sessionStart.getTime() + duration * 60000);
      const inProgressWindow = 15 * 60000; // 15 minutes

      if (now >= sessionStart && now <= sessionEnd) {
        return "in_progress";
      } else if (now > sessionEnd) {
        return "past";
      } else {
        return "upcoming";
      }
    }

    // Load User Data
    async function loadUserData(email) {
      try {
        // Load Sessions
        const sessionQuery = query(collection(db, "sessions"), where("student", "==", email));
        const sessionSnap = await getDocs(sessionQuery);
        sessionList.innerHTML = "";
        if (sessionSnap.empty) {
          sessionList.innerHTML = `<tr><td colspan="5" class="p-3 text-center">No sessions found</td></tr>`;
        } else {
          sessionSnap.forEach(doc => {
            const d = doc.data();
            const status = getSessionStatus(d.date, d.duration);
            sessionList.innerHTML += `
              <tr>
                <td class="p-3">${d.course}</td>
                <td class="p-3">${d.concept}</td>
                <td class="p-3">${d.duration} mins</td>
                <td class="p-3">${d.date}</td>
                <td class="p-3 status-${status.replace('_', '-')}">
                  ${status === 'in_progress' ? 'In Progress' : status.charAt(0).toUpperCase() + status.slice(1)}
                </td>
              </tr>`;
          });
        }

        // Load Billing
        const billingQuery = query(collection(db, "billing"), where("student", "==", email));
        const billingSnap = await getDocs(billingQuery);
        billingList.innerHTML = "";
        if (billingSnap.empty) {
          billingList.innerHTML = `<tr><td colspan="3" class="p-3 text-center">No billing records found</td></tr>`;
        } else {
          billingSnap.forEach(doc => {
            const b = doc.data();
            billingList.innerHTML += `
              <tr>
                <td class="p-3">$${b.amount}</td>
                <td class="p-3">${b.note || 'N/A'}</td>
                <td class="p-3">${b.date.toDate().toLocaleString()}</td>
              </tr>`;
          });
        }
      } catch (error) {
        alert(`Error loading data: ${error.message}`);
      }
    }

    // Authentication State
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loadUserData(user.email);
      } else {
        window.location.href = "index.html";
      }
    });

    // Logout
    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
        window.location.href = "index.html";
      } catch (error) {
        alert(`Error signing out: ${error.message}`);
      }
    });

    // Real-time Status Update
    function updateSessionStatuses() {
      const user = auth.currentUser;
      if (user) {
        loadUserData(user.email);
      }
    }

    // Update statuses every minute
    setInterval(updateSessionStatuses, 60000);
  </script>
</body>
</html>