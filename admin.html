<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel</title>
  <style>
    body {
      display: flex;
      font-family: sans-serif;
      padding: 20px;
    }
    .form, .side-panel {
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
      margin-right: 20px;
    }
    .form {
      flex: 2;
    }
    .side-panel {
      flex: 1;
      background: #f5f5f5;
    }
    input, textarea, select {
      width: 100%;
      margin: 5px 0 15px;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #aaa;
    }
    button {
      padding: 10px 20px;
      border: none;
      background: #007bff;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    h3 {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="form">
    <h2>Update Student Session</h2>
    <label>Email: <input type="email" id="studentEmail" /></label>
    <label>Date: <input type="date" id="date" /></label>
    <label>Course:
      <select id="topic">
        <option value="Catholic Social Teaching">Catholic Social Teaching</option>
        <option value="Accounting">Accounting</option>
        <option value="Math">Math</option>
      </select>
    </label>
    <label>Concept Covered:
      <input type="text" id="concept" placeholder="e.g. Preferential Option for the Poor" />
    </label>
    <label>Progress Comment:
      <textarea id="comment" placeholder="Student is improving in applying economic formulas..."></textarea>
    </label>
    <button onclick="submitUpdate()">Submit</button>
    <p id="status"></p>
  </div>

  <div class="side-panel">
    <h2>Enrolled Courses</h2>
    <ul>
      <li>Catholic Social Teaching</li>
      <li>Accounting</li>
      <li>Math</li>
    </ul>
    <h3>Concepts Covered</h3>
    <ul id="conceptList"></ul>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
    import { getFirestore, doc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCthkxyO-M5XSJ93jRO1uMg2J_Bnuq5gvc",
      authDomain: "my-tutor-a87b5.firebaseapp.com",
      projectId: "my-tutor-a87b5",
      storageBucket: "my-tutor-a87b5.appspot.com",
      messagingSenderId: "825619042650",
      appId: "1:825619042650:web:79d85905a01fcb90c12363",
      measurementId: "G-RLRNSD68QW"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    function loadConcepts(email) {
      const list = document.getElementById("conceptList");
      list.innerHTML = "";
      const q = query(collection(db, "sessions"), where("studentEmail", "==", email));
      getDocs(q).then(snapshot => {
        const added = new Set();
        snapshot.forEach(doc => {
          const concept = doc.data().concept;
          if (!added.has(concept)) {
            added.add(concept);
            const li = document.createElement("li");
            li.textContent = concept;
            list.appendChild(li);
          }
        });
      });
    }

    onAuthStateChanged(auth, user => {
      if (!user || user.email !== "admin@gmail.com") {
        alert("Access denied");
        window.location.href = "index.html";
      }
    });

    window.submitUpdate = async () => {
      const email = document.getElementById("studentEmail").value;
      const date = document.getElementById("date").value;
      const topic = document.getElementById("topic").value;
      const concept = document.getElementById("concept").value;
      const comment = document.getElementById("comment").value;
      const status = document.getElementById("status");

      if (!email || !date || !topic || !concept) {
        status.textContent = "Please fill in all fields.";
        return;
      }

      try {
        await setDoc(doc(db, "sessions", email + "_" + date), {
          studentEmail: email,
          date,
          topic,
          concept,
          comment
        });
        status.textContent = "Student session updated!";
        loadConcepts(email);
      } catch (err) {
        console.error(err);
        status.textContent = "Failed to update.";
      }
    };
  </script>
</body>
</html>